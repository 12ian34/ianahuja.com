{{ define "main" }}
<div class="miniti-page">
  <img src="/images/miniti-icon.png" alt="miniti icon" class="miniti-icon" />
  <h1>⬢ miniti</h1>
  <p class="miniti-tagline">native macOS AI meeting assistant</p>
  <ul class="miniti-features">
    <li>mic + system audio recording</li>
    <li>live transcription with deepgram</li>
    <li>live speaker identification</li>
    <li>live AI-generated summaries and action items</li>
    <li>live MEDDPICC analysis</li>
    <li>meeting history browser</li>
    <li>native menu bar controls</li>
    <li>keyboard shortcuts for everything</li>
  </ul>
  <p class="miniti-meta">500 mins/month for free<br>♾️ mins if you bring your own API keys</p>
  <div class="miniti-gallery-wrap">
    <button class="gallery-arrow gallery-arrow-left hidden" aria-label="Previous">&#8249;</button>
    <button class="gallery-arrow gallery-arrow-right" aria-label="Next">&#8250;</button>
    <div class="miniti-gallery">
      <div class="miniti-gallery-track">
        <img src="/images/miniti-1.png" alt="miniti screenshot 1" />
        <img src="/images/miniti-2.png" alt="miniti screenshot 2" />
        <img src="/images/miniti-3.png" alt="miniti screenshot 3" />
        <img src="/images/miniti-4.png" alt="miniti screenshot 4" />
      </div>
    </div>
    <div class="gallery-dots">
      <span class="gallery-dot active"></span>
      <span class="gallery-dot"></span>
      <span class="gallery-dot"></span>
      <span class="gallery-dot"></span>
    </div>
  </div>

  <div id="form-section" class="miniti-form-section">
    <form id="download-form" name="miniti-download" method="POST" data-netlify="true" netlify-honeypot="hpot-field">
      <p style="display:none"><label><input name="hpot-field" /></label></p>
      <input type="text" name="name" placeholder="name" required minlength="2" />
      <input type="email" name="email" placeholder="email" required />
      <button type="submit">get download link</button>
    </form>
  </div>

  <div id="success-section" class="miniti-message" style="display:none;">
    <p>check your email for the download link</p>
  </div>

  <div id="error-section" class="miniti-message miniti-error" style="display:none;">
    <p>something went wrong. try again?</p>
  </div>
</div>

<div class="miniti-lightbox" id="lightbox">
  <img id="lightbox-img" src="" alt="" />
</div>

<script>
  // Gallery
  const gallery = document.querySelector('.miniti-gallery');
  const wrap = document.querySelector('.miniti-gallery-wrap');
  const imgs = document.querySelectorAll('.miniti-gallery-track img');
  const dots = document.querySelectorAll('.gallery-dot');
  const arrowL = document.querySelector('.gallery-arrow-left');
  const arrowR = document.querySelector('.gallery-arrow-right');

  function getActiveIndex() {
    const center = gallery.scrollLeft + gallery.clientWidth / 2;
    let closest = 0, minDist = Infinity;
    imgs.forEach((img, i) => {
      const mid = img.offsetLeft + img.offsetWidth / 2;
      const dist = Math.abs(mid - center);
      if (dist < minDist) { minDist = dist; closest = i; }
    });
    return closest;
  }

  function updateGalleryUI() {
    const atEnd = gallery.scrollLeft + gallery.clientWidth >= gallery.scrollWidth - 10;
    const atStart = gallery.scrollLeft <= 10;
    wrap.classList.toggle('scrolled-end', atEnd);
    arrowL.classList.toggle('hidden', atStart);
    arrowR.classList.toggle('hidden', atEnd);
    const idx = getActiveIndex();
    dots.forEach((d, i) => d.classList.toggle('active', i === idx));
  }

  function scrollToImage(i) {
    const img = imgs[i];
    const offset = img.offsetLeft - gallery.clientWidth / 2 + img.offsetWidth / 2;
    gallery.scrollTo({ left: offset, behavior: 'smooth' });
  }

  arrowL.addEventListener('click', () => {
    const idx = Math.max(0, getActiveIndex() - 1);
    scrollToImage(idx);
  });

  arrowR.addEventListener('click', () => {
    const idx = Math.min(imgs.length - 1, getActiveIndex() + 1);
    scrollToImage(idx);
  });

  dots.forEach((dot, i) => {
    dot.addEventListener('click', () => scrollToImage(i));
  });

  gallery.addEventListener('scroll', updateGalleryUI, { passive: true });
  updateGalleryUI();

  // Lightbox
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img');

  document.querySelectorAll('.miniti-gallery-track img').forEach(img => {
    img.style.cursor = 'pointer';
    img.addEventListener('click', () => {
      lightboxImg.src = img.src;
      lightboxImg.alt = img.alt;
      lightbox.classList.add('active');
    });
  });

  function closeLightbox() {
    lightbox.classList.remove('active');
  }

  lightbox.addEventListener('click', closeLightbox);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLightbox();
  });

  function ph(event) {
    try { posthog.capture(event); } catch (_) {}
  }

  const form = document.getElementById('download-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const userName = form.querySelector('[name="name"]').value.trim();
    const userEmail = form.querySelector('[name="email"]').value.trim();
    const honeypot = form.querySelector('[name="hpot-field"]').value;

    if (honeypot) return; // bot

    const btn = form.querySelector('button');
    btn.disabled = true;
    btn.textContent = 'sending...';

    ph('miniti_download_submitted');

    try {
      // Submit to Netlify Forms (for records)
      const formData = new URLSearchParams();
      formData.append('form-name', 'miniti-download');
      formData.append('name', userName);
      formData.append('email', userEmail);
      await fetch('/', { method: 'POST', body: formData, headers: { 'Content-Type': 'application/x-www-form-urlencoded' } });

      // Trigger the verification email
      const res = await fetch('/.netlify/functions/request-download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: userName, email: userEmail }),
      });

      if (res.ok) {
        ph('miniti_download_success');
        document.getElementById('form-section').style.display = 'none';
        document.getElementById('success-section').style.display = 'block';
      } else {
        throw new Error('Request failed');
      }
    } catch (err) {
      ph('miniti_download_error');
      document.getElementById('error-section').style.display = 'block';
      btn.disabled = false;
      btn.textContent = 'get download link';
    }
  });
</script>
{{ end }}
